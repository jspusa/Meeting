<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æœƒè­°å®¤é ç´„ç³»çµ±</title>
  <style>
    :root { --primary: #4a90e2; --bg: #f5f7fa; --radius: 10px; --pad: 12px; --ff: 'Helvetica Neue', Arial, sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--ff); background: var(--bg); color: #333; padding: var(--pad); }
    h2 { margin: 0 0 16px; color: var(--primary); text-align: center; }
    h3 { margin: 32px 0 16px; color: var(--primary); text-align: center; }
    form { max-width: 600px; margin: 0 auto 24px; background: #fff; border-radius: var(--radius); padding: var(--pad); box-shadow: 0 4px 12px rgba(0,0,0,.05); }
    .row-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px 16px; margin-bottom: 16px; }
    .field { display: flex; flex-direction: column; }
    .label { font-weight: 600; margin-bottom: 6px; }
    select, input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; background: #fff; color: #333; }
    .input-group { position: relative; display: flex; }
    .input-group input { flex: 1; padding-right: 44px; }
    .picker-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); border:1px solid #cfe0ff; background:#eef4ff; color:#2d5bd1; border-radius:6px; padding:6px 8px; cursor:pointer; font-size:14px; line-height:1; }
    .picker-btn:hover { background: #dfeaff; }
    .btn { display: inline-block; padding: 8px 12px; font-size: 14px; border-radius: 6px; border: none; cursor: pointer; margin-right: 6px; margin-top: 4px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #357abd; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-secondary:hover { background: #5b636a; }
    .error { color: #e74c3c; font-weight: 700; text-align: center; margin-top: 6px; }
    .status { color: #2d5bd1; font-weight: 700; text-align: center; margin-top: 6px; }
    table { width:100%; max-width:900px; border-collapse:collapse; margin:16px auto; background:#fff; border-radius:var(--radius); overflow:hidden; }
    th, td { border:1px solid #e6e6e6; padding:8px 12px; text-align:center; font-size:.95em; }
    th { background: #f3f6fb; }
    .conflict { background:#ffe6e6; }
    .timetable { width:100%; max-width:900px; margin:16px auto; display:grid; grid-template-columns:60px repeat(5,1fr); grid-auto-rows:30px; gap:1px; background:#e6e6e6; border-radius:var(--radius); overflow:hidden; }
    .day-header, .time-cell, .slot { background:#fff; display:flex; align-items:center; justify-content:center; }
    .day-header { background:#f3f6fb; font-weight:700; }
    .time-cell { background:#f3f6fb; justify-content:flex-end; padding-right:8px; font-weight:400; }
    .slot { font-size:12px; cursor:pointer; }
    .booked { background: var(--primary); color:#fff; cursor:default; }
    .selected { background:#b3d4fc; }
    .lunch { background:#f0f0f0; }
    .cal-overlay, .time-overlay, .subject-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.2); align-items: center; justify-content: center; z-index: 1000; }
    .cal-panel, .time-panel, .subject-panel { background: #fff; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.25); padding: 12px; }
    .subject-panel button { display:block; width:100%; margin:4px 0; padding:8px 12px; border:1px solid #cfe0ff; border-radius:6px; background:#eef4ff; color:#2d5bd1; font-size:16px; cursor:pointer; }
    .subject-panel button:hover { background:#dfeaff; }
    .cal-overlay, .time-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.2); align-items: center; justify-content: center; z-index: 1000; }
    .cal-panel, .time-panel { background: #fff; border-radius: 12px; box-shadow: 0 10px 24px rgba(0,0,0,.25); padding: 12px; }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .cal-header button { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: #f7f7f7; cursor: pointer; }
    .cal-title { font-weight: 700; }
    .cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 6px; }
    .cal-grid .dow { background: #f3f6fb; font-weight: 700; padding: 8px 0; text-align: center; }
    .cal-grid .day { padding: 8px 0; border: 1px solid #eee; border-radius: 6px; text-align: center; cursor: pointer; }
    .cal-grid .day:hover { background: #eef4ff; border-color: #cfe0ff; }
    .cal-grid .disabled { opacity: .35; cursor: default; }
    .time-panel { display: flex; gap: 8px; justify-content: center; }
    .time-panel select { padding: 8px 6px; font-size: 16px; }
    .time-panel span { display: flex; align-items: center; font-size: 16px; }
    @media (max-width: 760px) { .row-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h2>æœƒè­°å®¤é ç´„ç³»çµ±</h2>
  <form id="bookingForm" autocomplete="off">
    <div class="row-2">
      <div class="field">
        <div class="label">è¾¦å…¬å®¤</div>
        <select id="office">
          <option value="huashan">è¯å±±è¾¦å…¬å®¤</option>
          <option value="sanchong">ä¸‰é‡è¾¦å…¬å®¤</option>
        </select>
      </div>
      <div class="field">
        <div class="label">æœƒè­°å®¤</div>
        <select id="room">
          <option value="å¤§æœƒè­°å®¤">å¤§æœƒè­°å®¤</option>
          <option value="å°æœƒè­°å®¤">å°æœƒè­°å®¤</option>
        </select>
      </div>
    </div>
    <div class="row-2">
      <div class="field">
        <div class="label">æœƒè­°ä¸»é¡Œ</div>
        <div class="input-group">
          <input type="text" id="subject" placeholder="è¼¸å…¥æœƒè­°ä¸»é¡Œ">
          <button type="button" class="picker-btn subject-picker-btn" data-target="subject">ğŸ“–</button>
        </div>
      </div>
      <div></div>
    </div>
    <div class="row-2">
      <div class="field">
        <div class="label">æ—¥æœŸ</div>
        <div class="input-group">
          <input type="text" id="date" placeholder="YYYY-MM-DD">
          <button type="button" class="picker-btn date-picker-btn" data-target="date">ğŸ“…</button>
        </div>
      </div>
      <div class="field">
        <div class="label">é–‹å§‹æ™‚é–“</div>
        <div class="input-group">
          <input type="text" id="startTime" placeholder="HH:MM">
          <button type="button" class="picker-btn time-picker-btn" data-target="startTime">â°</button>
        </div>
      </div>
    </div>
    <div class="row-2">
      <div class="field">
        <div class="label">çµæŸæ™‚é–“</div>
        <div class="input-group">
          <input type="text" id="endTime" placeholder="HH:MM">
          <button type="button" class="picker-btn time-picker-btn" data-target="endTime">â°</button>
        </div>
      </div>
      <div class="field">
        <div class="label">é ç´„äºº</div>
        <input type="text" id="organizer" placeholder="æ‚¨çš„å§“å">
      </div>
    </div>
    <div style="text-align:center;">
      <button type="submit" class="btn btn-primary">æäº¤é ç´„</button>
      <button type="button" id="resetBtn" class="btn btn-secondary">é‡ç½®</button>
    </div>
    <div id="statusMsg" class="status"></div>
    <div id="errorMsg" class="error"></div>
  </form>
  <table id="bookingTable">
    <thead>
      <tr><th>æ—¥æœŸ</th><th>æœƒè­°å®¤</th><th>ä¸»é¡Œ</th><th>æ™‚é–“</th><th>é ç´„äºº</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody><tr><td colspan="7" class="muted">å°šç„¡é ç´„</td></tr></tbody>
  </table>

  <details id="pastSection">
    <summary>éå¾€æœƒè­°</summary>
    <table id="pastTable">
      <thead>
        <tr><th>æ—¥æœŸ</th><th>æœƒè­°å®¤</th><th>ä¸»é¡Œ</th><th>æ™‚é–“</th><th>é ç´„äºº</th></tr>
      </thead>
      <tbody><tr><td colspan="5" class="muted">å°šç„¡è³‡æ–™</td></tr></tbody>
    </table>
    <div style="text-align:center;"><button id="clearPastBtn" class="btn btn-secondary">æ¸…é™¤éå¾€æœƒè­°</button></div>
  </details>

  <div id="weekView"></div>

  <!-- æ—¥æ›†è¦†è“‹å±¤ -->
  <div class="cal-overlay" id="calOverlay">
    <div class="cal-panel" role="dialog">
      <div class="cal-header">
        <button id="calPrev">â€¹</button>
        <div class="cal-title" id="calTitle">2025-08</div>
        <button id="calNext">â€º</button>
      </div>
      <div class="cal-grid" id="calGrid"></div>
    </div>
  </div>
  <!-- æ™‚é–“é¸æ“‡å™¨è¦†è“‹å±¤ -->
  <div class="time-overlay" id="timeOverlay">
    <div class="time-panel">
      <select id="hourSel"></select>
      <span>:</span>
      <select id="minTenSel"></select>
      <select id="minOneSel"></select>
    </div>
  </div>

  <!-- ä¸»é¡Œå¿«é€Ÿé¸æ“‡è¦†è“‹å±¤ -->
  <div class="subject-overlay" id="subjectOverlay">
    <div class="subject-panel">
      <button type="button" data-subject="è¡ŒéŠ·é€±æœƒ">è¡ŒéŠ·é€±æœƒ</button>
      <button type="button" data-subject="ç”¢éŠ·æœƒè­°">ç”¢éŠ·æœƒè­°</button>
      <button type="button" data-subject="AMZè£œè²¨æœƒè­°">AMZè£œè²¨æœƒè­°</button>
    </div>
  </div>

  <script>
  (function(){
    // è³‡æ–™å­˜å–
      async function loadBookings(){ const r=await fetch('/api/bookings'); return await r.json(); }
      async function loadPast(){ const r=await fetch('/api/past'); return await r.json(); }
      async function createBooking(nb){
        const r=await fetch('/api/bookings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(nb)});
        if(!r.ok) throw new Error('fail');
      }
    async function deleteBooking(idx){ await fetch(`/api/bookings/${idx}`,{method:'DELETE'}); }
    async function clearPast(){ await fetch('/api/past',{method:'DELETE'}); }
    function hasConflict(bs, nb){ return bs.some(b=>
      b.office===nb.office && b.room===nb.room && b.date===nb.date &&
      !(nb.endTime<=b.startTime||nb.startTime>=b.endTime)
    ); }
    async function renderTables(){ const tbody=document.querySelector('#bookingTable tbody'), pastBody=document.querySelector('#pastTable tbody');
      const bs = await loadBookings();
      const past = await loadPast();
      const office=document.getElementById('office').value;
      const now=new Date(); const day=now.getDay();
      const monday=new Date(now); monday.setDate(now.getDate()-((day+6)%7));
      const end=new Date(monday); end.setDate(monday.getDate()+11);
      const startStr=monday.toISOString().slice(0,10), endStr=end.toISOString().slice(0,10);
      const upcoming=bs.map((b,i)=>({b,i})).filter(e=>e.b.office===office && e.b.date>=startStr && e.b.date<=endStr);
      const pastList=past.map((b,i)=>({b,i})).filter(e=>e.b.office===office);
      if(!upcoming.length){ tbody.innerHTML='<tr><td colspan="7" class="muted">å°šç„¡é ç´„</td></tr>'; } else {
        upcoming.sort((a,b)=>a.b.date.localeCompare(b.b.date)||a.b.startTime.localeCompare(b.b.startTime));
        const conflicts=new Set();
        for(let i=0;i<upcoming.length;i++){
          for(let j=i+1;j<upcoming.length;j++){
            const a=upcoming[i].b, b=upcoming[j].b;
            if(a.room===b.room && a.date===b.date && !(a.endTime<=b.startTime||a.startTime>=b.endTime)){
              conflicts.add(i); conflicts.add(j);
            }
          }
        }
        tbody.innerHTML=upcoming.map((e,idx)=>`<tr${conflicts.has(idx)?' class="conflict"':''}>
          <td>${e.b.date}</td><td>${e.b.room}</td><td>${e.b.subject}</td>
          <td>${e.b.startTime} - ${e.b.endTime}</td><td>${e.b.organizer}</td>
          <td>${conflicts.has(idx)?'è¡çª':''}</td>
          <td><button class="del-btn" data-idx="${e.i}">åˆªé™¤</button></td>
        </tr>`).join(''); }
      if(!pastList.length){ pastBody.innerHTML='<tr><td colspan="5" class="muted">å°šç„¡è³‡æ–™</td></tr>'; } else {
        pastList.sort((a,b)=>b.b.date.localeCompare(a.b.date)||b.b.startTime.localeCompare(a.b.startTime));
        pastBody.innerHTML=pastList.map(e=>`<tr>
          <td>${e.b.date}</td><td>${e.b.room}</td><td>${e.b.subject}</td>
          <td>${e.b.startTime} - ${e.b.endTime}</td><td>${e.b.organizer}</td>
        </tr>`).join(''); }
      document.querySelectorAll('.del-btn').forEach(btn=>btn.addEventListener('click',async()=>{
        if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
        await deleteBooking(+btn.dataset.idx);
        await renderTables();
        await renderWeekView();
      })); }

    const presetColors={'è¡ŒéŠ·é€±æœƒ':'#2ecc71','ç”¢éŠ·æœƒè­°':'#e74c3c','AMZè£œè²¨æœƒè­°':'#e67e22'};
    const extraColors=['#3498db','#9b59b6','#1abc9c','#f1c40f','#7f8c8d'];
    const subjectColorMap={};
    let extraIdx=0;
    function colorForSubject(s){
      if(presetColors[s]) return presetColors[s];
      if(!subjectColorMap[s]){ subjectColorMap[s]=extraColors[extraIdx % extraColors.length]; extraIdx++; }
      return subjectColorMap[s];
    }
    let selectedSlots=[];
    function handleSlotClick(cell){
      if(cell.classList.contains('booked')) return;
      const date=cell.dataset.date;
      if(selectedSlots.length && selectedSlots[0].dataset.date!==date){
        selectedSlots.forEach(c=>c.classList.remove('selected'));
        selectedSlots=[];
      }
      if(cell.classList.contains('selected')){
        cell.classList.remove('selected');
        selectedSlots=selectedSlots.filter(c=>c!==cell);
      }else{
        cell.classList.add('selected');
        selectedSlots.push(cell);
      }
      if(selectedSlots.length){
        const mins=selectedSlots.map(c=>{const [h,m]=c.dataset.time.split(':').map(Number);return h*60+m;});
        const start=Math.min(...mins), end=Math.max(...mins)+30;
        const startStr=`${String(Math.floor(start/60)).padStart(2,'0')}:${String(start%60).padStart(2,'0')}`;
        const endStr=`${String(Math.floor(end/60)).padStart(2,'0')}:${String(end%60).padStart(2,'0')}`;
        document.getElementById('date').value=date;
        document.getElementById('startTime').value=startStr;
        document.getElementById('endTime').value=endStr;
      }
    }

    function autoFillEnd(){
      const start=document.getElementById('startTime').value;
      if(!/^\d{2}:\d{2}$/.test(start)) return;
      const [hh,mm]=start.split(':').map(Number);
      const d=new Date(); d.setHours(hh); d.setMinutes(mm+30);
      document.getElementById('endTime').value=`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function nextWeekday(dow){
      const now=new Date();
      const diff=(dow+7-now.getDay())%7;
      const target=new Date(now);
      target.setDate(now.getDate()+diff);
      const pad=n=>String(n).padStart(2,'0');
      return `${target.getFullYear()}-${pad(target.getMonth()+1)}-${pad(target.getDate())}`;
    }

    async function renderWeekView(){
      const wrap=document.getElementById('weekView');
      const office=document.getElementById('office').value;
      const room=document.getElementById('room').value;
      const bs=(await loadBookings()).filter(b=>b.office===office && b.room===room);
      const pad=n=>String(n).padStart(2,'0');
      const days=['é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”'];
      const now=new Date();
      const day=now.getDay();
      const monday=new Date(now);
      monday.setDate(now.getDate()-((day+6)%7));
      const next=new Date(monday); next.setDate(monday.getDate()+7);
      wrap.innerHTML='';
      selectedSlots=[];
      [monday,next].forEach((start,idx)=>{
        const title=document.createElement('h3');
        title.textContent=idx===0?'æœ¬é€±':'ä¸‹é€±';
        wrap.appendChild(title);
        const table=document.createElement('div');
        table.className='timetable';
        // å·¦ä¸Šç©ºç™½
        table.appendChild(document.createElement('div'));
        // æ˜ŸæœŸæ¨™é¡Œ
        for(let d=0;d<5;d++){
          const date=new Date(start); date.setDate(start.getDate()+d);
          const head=document.createElement('div');
          head.className='day-header';
          head.textContent=`${days[d]} ${pad(date.getMonth()+1)}/${pad(date.getDate())}`;
          table.appendChild(head);
        }
        // æ™‚é–“èˆ‡æ™‚æ®µæ ¼
        for(let t=0;t<20;t++){
          const mins=8*60+30+t*30;
          const hh=Math.floor(mins/60); const mm=mins%60;
          const timeStr=`${pad(hh)}:${pad(mm)}`;
          const timeCell=document.createElement('div');
          timeCell.className='time-cell';
          if(timeStr==='12:30'||timeStr==='13:00') timeCell.classList.add('lunch');
          timeCell.textContent=timeStr;
          table.appendChild(timeCell);
          for(let d=0;d<5;d++){
            const date=new Date(start); date.setDate(start.getDate()+d);
            const dateStr=`${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
            const cell=document.createElement('div');
            cell.className='slot'+(timeStr==='12:30'||timeStr==='13:00'?' lunch':'');
            cell.dataset.date=dateStr;
            cell.dataset.time=timeStr;
            cell.addEventListener('click',()=>handleSlotClick(cell));
            table.appendChild(cell);
          }
        }
        // æ¨™è¨˜é ç´„
        bs.forEach(b=>{
          const [sh,sm]=b.startTime.split(':').map(Number);
          const [eh,em]=b.endTime.split(':').map(Number);
          const sMin=sh*60+sm, eMin=eh*60+em;
          table.querySelectorAll(`.slot[data-date="${b.date}"]`).forEach(cell=>{
            const [ch,cm]=cell.dataset.time.split(':').map(Number);
            const cMin=ch*60+cm;
            if(cMin<eMin && cMin+30>sMin){
              cell.classList.add('booked');
              const color=colorForSubject(b.subject);
              cell.style.background=color;
              cell.style.color='#fff';
              cell.textContent=b.subject;
            }
          });
        });
        wrap.appendChild(table);
      });
    }

    // è¡¨å–®äº‹ä»¶
    const form=document.getElementById('bookingForm'), err=document.getElementById('errorMsg'), status=document.getElementById('statusMsg');
    form.addEventListener('submit',async e=>{ e.preventDefault(); err.textContent=''; status.textContent='';
        const office=form.office.value, room=form.room.value, subject=form.subject.value.trim();
        const date=form.date.value, start=form.startTime.value, end=form.endTime.value;
        const org=form.organizer.value.trim();
        if(!office||!room||!subject||!/^\d{4}-\d{2}-\d{2}$/.test(date)||!/^\d{2}:\d{2}$/.test(start)||!/^\d{2}:\d{2}$/.test(end)||!org){
          err.textContent='è«‹å®Œæ•´ä¸”æ­£ç¢ºå¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚'; return; }
        const todayStr=minDate.toISOString().slice(0,10), maxStr=maxDate.toISOString().slice(0,10);
        if(date<todayStr||date>maxStr){ err.textContent='æ—¥æœŸéœ€åœ¨30å¤©å…§ã€‚'; return; }
        const [sh,sm]=start.split(':').map(Number), [eh,em]=end.split(':').map(Number);
        const sMin=sh*60+sm, eMin=eh*60+em;
        if(sMin<510||eMin>1080){ err.textContent='æ™‚é–“éœ€åœ¨08:30-18:00ä¹‹é–“ã€‚'; return; }
        if(eMin<=sMin){ err.textContent='çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“ã€‚'; return; }
        const nb={office,room,date,startTime:start,endTime:end,subject,organizer:org}, bs=await loadBookings();
        if(hasConflict(bs,nb)){
          if(!confirm('æ­¤æ™‚æ®µèˆ‡ç¾æœ‰é ç´„è¡çªï¼Œä»è¦é ç´„ï¼Ÿ')) return;
        }
        status.textContent='å·²æäº¤é ç´„ï¼Œè«‹ç¨å€™ç³»çµ±ä¸Šå‚³';
        try{ await createBooking(nb); } catch(e){ status.textContent=''; err.textContent='æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚'; return; }
        const keepOffice=form.office.value;
        status.textContent='';
        await renderTables();
        await renderWeekView();
        form.reset();
        form.office.value=keepOffice;
    });
    document.getElementById('resetBtn').addEventListener('click',()=>{ form.reset(); err.textContent=''; status.textContent=''; renderTables(); renderWeekView(); });
    document.getElementById('office').addEventListener('change',()=>{ renderTables(); renderWeekView(); });
    document.getElementById('room').addEventListener('change',()=>{ renderWeekView(); });
    document.getElementById('startTime').addEventListener('change',autoFillEnd);
    document.getElementById('clearPastBtn').addEventListener('click',async()=>{
      if(!confirm('ç¢ºå®šæ¸…é™¤éå¾€æœƒè­°ï¼Ÿ')) return;
      await clearPast();
      await renderTables();
    });

    // æ—¥æœŸï¼æ™‚é–“é¸æ“‡å™¨å…±ç”¨
    const calOverlay=document.getElementById('calOverlay'), grid=document.getElementById('calGrid'), titleEl=document.getElementById('calTitle'), prevBtn=document.getElementById('calPrev'), nextBtn=document.getElementById('calNext');
    const timeOverlay=document.getElementById('timeOverlay'), hourSel=document.getElementById('hourSel'), minTenSel=document.getElementById('minTenSel'), minOneSel=document.getElementById('minOneSel');
    const subjectOverlay=document.getElementById('subjectOverlay');
    let activeDateInput=null, activeTimeInput=null, viewY, viewM;
    const today=new Date();
    const minDate=new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const maxDate=new Date(minDate); maxDate.setDate(maxDate.getDate()+30);
    const minYM=minDate.getFullYear()*12+minDate.getMonth();
    const maxYM=maxDate.getFullYear()*12+maxDate.getMonth();
    // åˆå§‹åŒ–æ™‚é–“ä¸‹æ‹‰
      function buildTime(){
        const hours=Array.from({length:11},(_,i)=>String(i+8).padStart(2,'0'));
        hourSel.innerHTML=hours.map(h=>`<option value="${h}">${h}</option>`).join('');
        minTenSel.innerHTML=Array.from({length:6},(_,i)=>`<option value="${i}">${i}</option>`).join('');
        minOneSel.innerHTML=Array.from({length:10},(_,i)=>`<option value="${i}">${i}</option>`).join(''); }
    buildTime();
    // æ‰“é–‹æ—¥æ›†
    function openCalendar(id){ activeDateInput=document.getElementById(id);
      const v=activeDateInput.value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      let now=v?new Date(+v[1],+v[2]-1,+v[3]):new Date();
      if(now<minDate) now=minDate;
      if(now>maxDate) now=maxDate;
      viewY=now.getFullYear(); viewM=now.getMonth(); renderCal(); calOverlay.style.display='flex'; }
    function closeCalendar(){ calOverlay.style.display='none'; activeDateInput=null; }
    function renderCal(){ const pad=n=>String(n).padStart(2,'0'); titleEl.textContent=`${viewY}-${pad(viewM+1)}`;
      const first=new Date(viewY,viewM,1), last=new Date(viewY,viewM+1,0), startDow=first.getDay(), days=last.getDate();
      let html=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w=>`<div class="dow">${w}</div>`).join('');
      for(let i=0;i<startDow;i++) html+=`<div class="disabled"></div>`;
      for(let d=1;d<=days;d++){ const date=new Date(viewY,viewM,d); const dis=date<minDate||date>maxDate; html+=`<div class="day${dis?' disabled':''}" data-day="${d}">${d}</div>`; }
      grid.innerHTML=html;
      document.querySelectorAll('.day').forEach(cell=>{ if(cell.classList.contains('disabled')) return; cell.addEventListener('click',()=>{ const d=+cell.dataset.day; activeDateInput.value=`${viewY}-${pad(viewM+1)}-${pad(d)}`; closeCalendar(); }); });
      prevBtn.disabled=(viewY*12+viewM)<=minYM;
      nextBtn.disabled=(viewY*12+viewM)>=maxYM;
    }
    prevBtn.addEventListener('click',()=>{ if(prevBtn.disabled) return; viewM--; if(viewM<0){viewM=11;viewY--;} renderCal(); });
    nextBtn.addEventListener('click',()=>{ if(nextBtn.disabled) return; viewM++; if(viewM>11){viewM=0;viewY++;} renderCal(); });
    calOverlay.addEventListener('click',e=>{ if(e.target===calOverlay) closeCalendar(); });
    // æ‰“é–‹æ™‚é–“é¸æ“‡å™¨
    function openTime(id){ activeTimeInput=document.getElementById(id); const v=activeTimeInput.value.match(/^(\d{2}):(\d{2})$/);
      if(v){ hourSel.value=v[1]; const m=+v[2]; minTenSel.value=Math.floor(m/10); minOneSel.value=m%10;} timeOverlay.style.display='flex'; }
    function closeTime(){ timeOverlay.style.display='none'; activeTimeInput=null; }
    function updateTime(){ if(!activeTimeInput) return; const hh=hourSel.value, mm=String(minTenSel.value*10+ +minOneSel.value).padStart(2,'0'); activeTimeInput.value=`${hh}:${mm}`; if(activeTimeInput.id==='startTime') autoFillEnd(); }
    timeOverlay.addEventListener('click',e=>{ if(e.target===timeOverlay) closeTime(); });
    hourSel.addEventListener('change',updateTime); minTenSel.addEventListener('change',updateTime); minOneSel.addEventListener('change',()=>{ updateTime(); closeTime(); });
    subjectOverlay.addEventListener('click',e=>{ if(e.target===subjectOverlay) subjectOverlay.style.display='none'; });
    subjectOverlay.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',()=>{
      const subj=btn.dataset.subject;
      document.getElementById('subject').value=subj;
      if(subj==='è¡ŒéŠ·é€±æœƒ'){
        document.getElementById('date').value=nextWeekday(5);
        document.getElementById('startTime').value='10:30';
        document.getElementById('endTime').value='12:30';
      }else if(subj==='AMZè£œè²¨æœƒè­°'){
        document.getElementById('date').value=nextWeekday(1);
        document.getElementById('startTime').value='14:30';
        document.getElementById('endTime').value='15:30';
      }
      subjectOverlay.style.display='none';
    }));
    // ç¶å®šæŒ‰éˆ•
    document.querySelectorAll('.date-picker-btn').forEach(btn=>btn.addEventListener('click',()=>openCalendar(btn.dataset.target)));
    document.querySelectorAll('.time-picker-btn').forEach(btn=>btn.addEventListener('click',()=>openTime(btn.dataset.target)));
    document.querySelectorAll('.subject-picker-btn').forEach(btn=>btn.addEventListener('click',()=>{ subjectOverlay.style.display='flex'; }));
    renderTables();
    renderWeekView();
  })();
  </script>
</body>
</html>
